name: Publish to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  MODULE_NAME: GuestConfigurationHelper

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Get release information
        id: release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ./.github/workflows/scripts/Get-ReleaseInformation.ps1 `
            -EventName "${{ github.event_name }}" `
            -ReleaseTagName "${{ github.event.release.tag_name }}" `
            -Repository "${{ github.repository }}" `
            -ModuleName "${{ env.MODULE_NAME }}"

      - name: Download module package from release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ./.github/workflows/scripts/Download-ModulePackage.ps1 `
            -Tag "${{ steps.release.outputs.tag }}" `
            -AssetName "${{ steps.release.outputs.asset_name }}" `
            -Repository "${{ github.repository }}"

      - name: Extract module package
        shell: pwsh
        run: ./.github/workflows/scripts/Extract-ModulePackage.ps1 -AssetName "${{ steps.release.outputs.asset_name }}" -ModuleName "${{ env.MODULE_NAME }}"

      - name: Install required PowerShell modules
        shell: pwsh
        run: ./.github/workflows/scripts/Install-Modules.ps1
        
      - name: Validate module artifact
        id: validate
        shell: pwsh
        run: ./.github/workflows/scripts/Validate-ModuleArtifact.ps1 -ModuleName "${{ env.MODULE_NAME }}"

      - name: Check if version exists in PowerShell Gallery
        shell: pwsh
        run: |
          ./.github/workflows/scripts/Check-PSGalleryVersion.ps1 `
            -ModuleName "${{ steps.validate.outputs.module_name }}" `
            -ModuleVersion "${{ steps.validate.outputs.module_version }}"

      - name: Publish module to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PS_GALLERY_API_KEY }}
        run: |
          ./.github/workflows/scripts/Publish-ModuleToPSGallery.ps1 `
            -ModulePath "${{ steps.validate.outputs.module_path }}" `
            -ModuleName "${{ steps.validate.outputs.module_name }}" `
            -ModuleVersion "${{ steps.validate.outputs.module_version }}"

      - name: Summary
        if: success()
        shell: pwsh
        run: |
          ./.github/workflows/scripts/Show-PublishSummary.ps1 `
            -ModuleName "${{ steps.validate.outputs.module_name }}" `
            -Version "${{ steps.validate.outputs.module_version }}"
